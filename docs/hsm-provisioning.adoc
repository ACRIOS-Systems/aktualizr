= Implicit Provisioning with an HSM

This document describes the current support for implicit provisioning with an HSM in Aktualizr and https://github.com/advancedtelematic/meta-updater[meta-updater].

== Background

In automatic provisioning, bootstrap credentials are downloaded and installed on devices to initiate the provisioning process. In implicit provisioning with an HSM, devices shall have an HSM that is pre-loaded with the requisite provisioning credentials. These credentials shall be signed by a root CA certificate which shall be uploaded to the server. The server will thus be able to authenticate a client device by verifying that the client's certificate was signed by the uploaded root CA.

== Configuration

The following items are relevant for implicit provisioning:

// tag::summary-table[]

[options=header]
|===================
| Configuration option         | Where it will come from/what it does
| Server URL                   | Read from credentials archive
| Server Root CA cert          | Read from credentials archive
| Fleet Root CA cert           | Chain of trust for a device fleet; provided by the user. Must be uploaded by user to the server.
| Fleet Root CA private key    | Key for signing device certs in the fleet; provided by user, but used only for signing. Not stored on device.
| TLS device cert              | Pre-installed in the device HSM; must be signed by Fleet Root CA private key
| TLS device key               | Pre-installed in the device HSM
| Device ID                    | Read from Common Name field of TLS device cert
| Uptane public/private key    | Automatically generated by Aktualizr
| Uptane primary serial number | Automatically generated by Aktualizr
| Primary ECU Hardware ID      | Automatically generated by Aktualizr
|===================

// end::summary-table[]

An example `.toml` configuration file can be found at link:../config/sota_hsm_prov.toml[]. This is what is used as in input to `implicit_writer` during bitbaking with meta-updater.

== Steps

// tag::full-instructions[]

. Generate a root CA private key and self-signed certificate.
+
If you do not have your own CA certificate for signing device certificates, you can generate a self-signed certificate for testing.
+
ifdef::env-github[]
You can examine the `new_server` function in link:https://github.com/advancedtelematic/ota-community-edition/blob/master/scripts/start.sh#L127[OTA Community Edition's `start.sh`] for one way of generating the cert.
endif::[]
ifndef::env-github[]
First, create a directory structure for the keys, and grab sample configurations for the certificates from the OTA Community Edition project:
+
[source,bash]
----
export SERVER_NAME=myservername
export SERVER_DIR="./${SERVER_NAME}" DEVICES_DIR="./${SERVER_NAME}/devices" CWD="${PWD}"
mkdir -p "$DEVICES_DIR" certs
for file in client.cnf device_ca.cnf server.ext client.ext server.cnf server_ca.cnf; do
  curl -o certs/$file https://raw.githubusercontent.com/advancedtelematic/ota-community-edition/master/scripts/certs/$file
done
----
+
Then, generate the key and cert using openssl on the command line:
+
[source,bash]
----
include::https://raw.githubusercontent.com/advancedtelematic/ota-community-edition/master/scripts/start.sh[tags="genserverkeys"]
----
endif::[]
+
This will create a `./${SERVER_DIR}/devices/` directory with the `ca.crt` certificate and a `ca.key` private key. Keep the private key safe and secure.
. Upload the root CA certificate to the server. To add a root CA certificate to link:https://atsgarage.com[ATS Garage], contact link:mailto:support@atsgarage.com[support@atsgarage.com].
. Generate a device certificate and key, and sign it with the root CA you just created.
+
ifdef::env-github[]
Examine the link:https://github.com/advancedtelematic/ota-community-edition/blob/master/scripts/start.sh#L89[`new_client` function in start.sh] for one way to do that.
endif::[]
ifndef::env-github[]
Generate a UUID for the device, and make a directory for it:
+
[source,bash]
----
export DEVICE_UUID=$(uuidgen | tr "[:upper:]" "[:lower:]")
export device_id=${DEVICE_ID:-${DEVICE_UUID}} device_dir="${DEVICES_DIR}/${DEVICE_UUID}"
mkdir -p "${device_dir}"
----
+
Then, generate the device certificate and key using openssl:
+
[source,bash]
----
include::https://raw.githubusercontent.com/advancedtelematic/ota-community-edition/master/scripts/start.sh[tags="genclientkeys"]
----
endif::[]
. Add the internal root CA certificate of the device gateway the device will connect to. To get the device gateway's certificate, use openssl:
+
----
export device_gateway=your-gateway-url # for ATS Garage, looks something like
    # a3378fca-4e4c-4a5d-b1c2-d5c5ec35b3c2.tcpgw.prod01.advancedtelematic.com
openssl s_client -connect ${device_gateway}:8000 -servername $device_gateway -showcerts | \
  sed -n '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > ${device_dir}/root.crt 
----
. Add the following lines to your `conf/local.conf`:
+
----
SOTA_CLIENT_FEATURES = "hsm"
SOTA_CLIENT_PROV = "aktualizr-hsm-prov"
----
. Build a standard image using bitbake. Make sure an ssh server is installed; usually you can do this with `IMAGE_INSTALL_append = " dropbear "`.
. Boot the image.
. Copy the device credentials and device gateway root CA certificate to the device's HSM. For the QEMU simulated HSM, enter the device directory whose credentials you wish to copy, then do:
+
----
scp -P 2222 -pr ./ root@localhost:/var/sota/token
----
. The server authenticates the client device by verifying that the client's certificate was signed by the root CA private key that was uploaded in step 2.
. The client device authenticates the server by verifying that the server's certificate was signed by the server's internal root CA private key.
. The device is provisioned, and will appear online in the web UI.

// end::full-instructions[]

== Simulated implicit provisioning with `cert_provider`

Implicit provisioning can be simulated with `cert_provider` without need for the user to create a root CA. `cert_provider` uses the existing autoprovisioning mechanisms to pre-install a certificate and key on the device.

// tag::quick-instructions[]

1. In meta-updater, set `SOTA_CLIENT_PROV = "aktualizr-hsm-prov"`. Currently, you will also need to set `SOTA_PACKED_CREDENTIALS` to provisioning credentials zip file.
1. Build a standard image using bitbake.
1. Boot the image.
1. Optionally, verify that Aktualizr is not provisioning and that the device is not visible in the Garage.
1. Load credentials onto the device, for example with `cert_provider` from the Aktualizr repo: `cert_provider -c credentials.zip -t <device> -d /var/sota`
1. Verify that Aktualizr provisions correctly with the server using the expected Device ID.

// end::quick-instructions[]

== Credentials format

The provisioning credentials zip file format is specified in link:credentials.adoc[]. However, the only files in the archive used by `implicit_writer` are `autoprov.url` and `autoprov_credentials.p12`. Optionally, instead of including `autoprov_credentials.p12`, `implicit_writer` will also try looking for a file named `server_ca.pem` from which to read the server's root CA certificate. Note that `treehub.json` is required by `garage-sign`, and offline signing may require additional files.

`cert_provider`, if used, also requires `autoprov.url` and `autoprov_credentials.p12`. Because `cert_provider` autoprovisions with the server, `server_ca.pem` cannot be substituted in place of `autoprov_credentials.p12`.
