# Hacky Implicit Provisioning

This document describes a quick hack to test the implicit provisioning flow before full support is available in Aktualizr and meta-updater.

## Goals

* end-to-end installation of updates using OSTree

## Overview

The following need to be setup:

[options=header]
|===================
| Configuration option | Where it will come from
| Server URL | /sysroot/boot/sota.toml
| TLS CA/key/cert | Copied into `/var/sota` via SSH
| Device ID | Implicit in TLS cert, ignore the device id in `/var/sota/device_id`
| Uptane public/private key | Automatically generated by Aktualizr
| Uptane primary serial number | Automatically generated by Aktualizr
| Primary ECU Hardware ID | Automatically generated by Aktualizr
|===================

## Steps

1. Generate suitable root CA, device private key and certificate using the openssl tools.
1. Build a standard image using bitbake, bit don't set `SOTA_PACKED_CREDENTIALS`
1. Boot the image
1. Stop the aktualizr service
1. `scp pkey.pem ca.pem client.pem qemu:/var/sota/`
1. Edit `config/sota_implicit_demo.toml` and set `server` in the `[tls]` section.
1. `scp sota_implicit_demo.toml qemu:/sysroot/boot/sota.toml`
1. Restart the aktualizr service

Note that if the director reports that the device is already provisioned, it will delete pkey.pem, ca.pem, client.pem before restarting provisioning.  This attempt will fail because the autoprovisioning credentials are not present, but the files are already deleted.  (Thus the title of this document).

